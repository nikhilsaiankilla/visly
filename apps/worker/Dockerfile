# ---- build ----
FROM node:20-alpine AS build
WORKDIR /app

ARG CLICKHOUSE_URL
ARG CLICKHOUSE_DATABASE
ARG CLICKHOUSE_USER_NAME
ARG CLICKHOUSE_PASSWORD
ARG CLICKHOUSE_BATCH_SIZE
ARG CLICKHOUSE_FLUSH_INTERVAL_MS
ARG KAFKA_BROKER
ARG KAFKA_USERNAME
ARG KAFKA_PASSWORD
ARG KAFKA_TOPIC
ARG KAFKA_PORT
ARG KAFKA_CLIENT_ID
ARG KAFKA_CA_CERTIFICATE
ARG KAFKA_RETRY_TOPIC
ARG KAFKA_DLQ_TOPIC
ARG KAFKA_GROUP_ID

# expose them to `npm run build`
ENV CLICKHOUSE_URL=$CLICKHOUSE_URL \
    CLICKHOUSE_DATABASE=$CLICKHOUSE_DATABASE \
    CLICKHOUSE_USER_NAME=$CLICKHOUSE_USER_NAME \
    CLICKHOUSE_PASSWORD=$CLICKHOUSE_PASSWORD \
    CLICKHOUSE_BATCH_SIZE=$CLICKHOUSE_BATCH_SIZE \
    CLICKHOUSE_FLUSH_INTERVAL_MS=$CLICKHOUSE_FLUSH_INTERVAL_MS \
    KAFKA_BROKER=$KAFKA_BROKER \
    KAFKA_USERNAME=$KAFKA_USERNAME \
    KAFKA_PASSWORD=$KAFKA_PASSWORD \
    KAFKA_TOPIC=$KAFKA_TOPIC \
    KAFKA_PORT=$KAFKA_PORT \
    KAFKA_CLIENT_ID=$KAFKA_CLIENT_ID \
    KAFKA_CA_CERTIFICATE=$KAFKA_CA_CERTIFICATE \
    KAFKA_RETRY_TOPIC=$KAFKA_RETRY_TOPIC \
    KAFKA_DLQ_TOPIC=$KAFKA_DLQ_TOPIC \
    KAFKA_GROUP_ID=$KAFKA_GROUP_ID 

COPY package.json ./
RUN npm install
COPY tsconfig.json ./tsconfig.json
COPY src ./src
RUN npm run build

# ---- run ----
FROM node:20-alpine AS run
ENV NODE_ENV=production
WORKDIR /app
COPY package.json ./
RUN npm install --omit=dev
COPY --from=build /app/dist ./dist
EXPOSE 3002
CMD ["node","dist/index.js"]
