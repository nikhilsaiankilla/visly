name: Publish visly-sdk

on:
    push:
        tags:
            - "sdk-v*.*.*" # e.g. sdk-v0.1.6

jobs:
    publish:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        defaults:
            run:
                working-directory: packages/sdk
        steps:
            - name: Checkout (full history)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect SDK changes since previous tag
              id: changed
              shell: bash
              run: |
                  # current tag commit
                  THIS_SHA="$(git rev-list -n 1 $GITHUB_REF_NAME)"
                  # previous sdk tag (if any)
                  PREV_TAG="$(git describe --tags --match 'sdk-v*' --abbrev=0 "$THIS_SHA^" 2>/dev/null || true)"
                  if [ -z "$PREV_TAG" ]; then
                    echo "first release => changed=true"
                    echo "changed=true" >> $GITHUB_OUTPUT
                    exit 0
                  fi
                  echo "prev tag: $PREV_TAG"
                  # did anything under packages/sdk change?
                  if git diff --quiet "$PREV_TAG".."$THIS_SHA" -- packages/sdk ; then
                    echo "changed=false" >> $GITHUB_OUTPUT
                  else
                    echo "changed=true" >> $GITHUB_OUTPUT
                  fi

            - name: Stop (no changes in packages/sdk)
              if: steps.changed.outputs.changed != 'true'
              run: |
                  echo "No changes detected under packages/sdk since previous SDK tag. Skipping publish."
                  exit 0

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  registry-url: https://registry.npmjs.org/

            - name: Install deps
              run: npm ci

            - name: Build
              run: npm run build

            - name: Publish to npm
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: npm publish --access public
